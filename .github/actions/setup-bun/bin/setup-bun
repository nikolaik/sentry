#!/usr/bin/env python3
import argparse
import hashlib
import io
import os.path
import platform
import secrets
import shutil
import stat
import sys
import urllib.request
import zipfile

BUN = "0.5.7"
BUN_DIR = os.path.expanduser("~/.local/share/bun")
BUN_CACHE_DIR = os.path.expanduser("~/.bun")
BUN_EXE = os.path.join(BUN_DIR, "bun")

BUN_ARCH = {
    "x86_64": "x64",
    "aarch64": "aarch64",
    "arm64": "arm64",
}[platform.machine()]

URL = (
    f"https://github.com/oven-sh/bun/releases/download/bun-v{BUN}/bun-{sys.platform}-{BUN_ARCH}.zip"
)

SHA256 = {
    ("darwin", "aarch64"): "9b4945a2419f258dea5cb60ee2f9c516a29bdff20f45758ddcbe8f5790eab57d",
    ("darwin", "x64"): "46e6744f963b562f66b7214bf2e97bd793113b85e8cc37f4592faa8dacb1d648",
    ("linux", "aarch64"): "5d251b7d1923a3bca23eb3dafcca77d16a2515ec7e12fce2a61badd6c29f9431",
    ("linux", "x64"): "b8e5474088ef656d06aaffc62e5bdb5e5e5b0dc9f047cd003f5954276bf66683",
}[sys.platform, BUN_ARCH]


def _command_vars() -> int:
    with open(os.environ["GITHUB_OUTPUT"], "a") as f:
        f.write(f"bun-dir={BUN_DIR}\n")
        f.write(f"bun-cache-dir={BUN_CACHE_DIR}\n")
        f.write(f"cache-key=bun-{BUN}-{BUN_ARCH}-{SHA256}\n")

    print(f"adding {BUN_DIR} to path")
    with open(os.environ["GITHUB_PATH"], "a+") as f:
        f.write(f"{BUN_DIR}\n")

    return 0


def _make_executable(filename: str) -> None:
    original_mode = os.stat(filename).st_mode
    new_mode = original_mode | stat.S_IXUSR | stat.S_IXGRP | stat.S_IXOTH
    os.chmod(filename, new_mode)


def _command_install() -> int:
    print("downloading...")
    req = urllib.request.urlopen(URL, timeout=30)
    bio = io.BytesIO(req.read())
    checksum = hashlib.sha256(bio.getvalue()).hexdigest()
    if not secrets.compare_digest(checksum, SHA256):
        print(f"bun checksum mismatch {checksum} {SHA256}")
        return 1

    print("extracting...")
    os.makedirs(BUN_DIR, exist_ok=True)
    with zipfile.ZipFile(bio) as zipf:
        with zipf.open(f"bun-{sys.platform}-{BUN_ARCH}/bun") as src_f:
            with open(BUN_EXE, "wb") as f:
                shutil.copyfileobj(src_f, f)
    _make_executable(BUN_EXE)

    return 0


def main() -> int:
    parser = argparse.ArgumentParser()
    parser.add_argument("command", choices=("vars", "install"))
    args = parser.parse_args()

    return {
        "vars": _command_vars,
        "install": _command_install,
    }[args.command]()


if __name__ == "__main__":
    raise SystemExit(main())
